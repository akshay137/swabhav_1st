<!DOCTYPE html>
<html lang="en-US">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Tasks</title>

	<link rel="stylesheet" href="bootstrap/css/bootstrap.css">
</head>

<body>
	<div id="root" class="container-xl">
		<h1 class="text-center">Tasks</h1>
		<div class="form-group container-sm">
			<label for="task-text">Task details:</label>
			<input type="text" id="task-text" class="form-control"
				placeholder="Enter task detail here" />
		</div>

		<div class="container-sm" id="task-list-view">
			<div id="empty-div"></div>
			<!-- content generated by script -->
		</div>
	</div>

	<script type="text/javascript" src="scripts/jquery-3.4.1.js"></script>
	<script type="text/javascript" src="bootstrap/js/bootstrap.bundle.js">
	</script>
	<script type="text/javascript" src="scripts/moment.js"></script>
	<script>
		(function () {
			const taskIp = $('#task-text');
			const taskListView = $('#task-list-view');

			let tasklist = [];
			let newTaskId = 0;
			const taskListKey = 'tasklist';
			const dateFormat = 'DD-MM-YYYY hh:mm:ss a';

			const saveTask = function () {
				localStorage.setItem(taskListKey, JSON.stringify(tasklist));
			}

			const removeTaskFromList = function (taskId) {
				const i = tasklist.findIndex((task) => {
					return task.id == taskId;
				})
				if (i == -1)
					return;

				tasklist.splice(i, 1);
				saveTask();
			}

			const generateTaksMarkup = function (task) {
				const time = moment(task.time, dateFormat).fromNow();
				let taskDiv = document.createElement('div');
				taskDiv.classList.add('row', 'bg-dark', 'text-center',
					'p-1', 'border', 'border-light');

				let timeDiv = document.createElement('span');
				timeDiv.innerHTML = time;
				timeDiv.classList.add('col-sm-3', 'text-primary');

				let taskDetail = document.createElement('span');
				taskDetail.innerHTML = task.details;
				taskDetail.classList.add('col-sm', 'text-light', 'h3');

				let btn = document.createElement('button');
				btn.innerHTML = '&times;';
				btn.addEventListener('click', (e) => {
					if (!confirm('Remove task:\n' + task.details))
						return;
					$('#' + task.id).remove();
					removeTaskFromList(task.id);
				});
				btn.classList.add('col-sm-1', 'btn', 'btn-sm', 'btn-danger');

				taskDiv.id = task.id;
				taskDiv.append(timeDiv);
				taskDiv.append(taskDetail);
				taskDiv.append(btn);

				return taskDiv;
			}

			const addTask = function (task) {
				// console.log(task);
				$(generateTaksMarkup(task)).insertBefore(
					taskListView.children().first());
			}

			const loadTaskList = function () {
				console.log('loading tasks');
				tasklist = JSON.parse(localStorage.getItem(taskListKey));
				if (tasklist == null)
					tasklist = [];
				newTaskId = tasklist.length == 0
					? 0 : tasklist[tasklist.length - 1].id;
				tasklist.forEach((task) => {
					addTask(task);
				})
			}

			const onTaskEnter = function (e) {
				let task = {
					id: newTaskId++,
					details: taskIp.val(),
					time: moment().format(dateFormat)
				};
				tasklist.push(task);
				addTask(task);
				saveTask();
			}

			$(document).ready(() => {
				loadTaskList();
				taskIp.on('keyup', (e) => {
					if (e.key == 'Enter') {
						onTaskEnter(e);
					}
				});
			});
		})();
	</script>
</body>

</html>